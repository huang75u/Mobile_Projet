# 每日数据重置功能说明

## 功能概述
实现了主界面（HomeScreen）和运动界面（ExerciseScreen）的每日数据联动更新机制。当跨过一天时，两个界面会自动同步清除昨天的运动数据，开始新的一天。

## 实现的修改

### 1. UserPreferences.kt
- 添加了 `lastActiveDate` 字段用于追踪用户最后活跃日期
- 使用格式：`yyyyMMdd`（如：20241022）

### 2. ExerciseViewModel.kt
- **新增方法 `checkAndResetDailyData()`**：
  - 检查当前日期与上次活跃日期
  - 如果日期发生变化（跨天），执行以下操作：
    - 清除运动数据，只保留最近7天的历史数据（用于周统计）
    - 重新计算积分（新的一天积分为0）
  - 更新 `lastActiveDate` 为当前日期

- **修复 `calculateAndUpdatePoints()` 方法**：
  - 现在只计算今天的运动数据来计算积分
  - 避免将历史数据计入今天的积分

### 3. ExerciseScreen.kt
- 添加了 `LaunchedEffect` 在界面加载时调用 `checkAndResetDailyData()`
- 确保每次进入运动界面时检查日期更新

### 4. HomeScreen.kt
- 添加了 `LaunchedEffect` 在界面加载时调用 `checkAndResetDailyData()`
- 确保主界面和运动界面数据保持同步

## 工作流程

1. 用户打开应用或切换到主界面/运动界面
2. 自动触发 `checkAndResetDailyData()`
3. 系统检查当前日期与上次活跃日期：
   - **如果是同一天**：不做任何操作，继续显示当天数据
   - **如果日期变化（跨天）**：
     - 清除运动数据（只保留最近7天用于历史统计）
     - 积分重置为0
     - 更新最后活跃日期
4. 两个界面都显示新一天的数据（空白状态）

## 数据保留策略

- **今天的数据**：实时显示和统计
- **历史数据**：保留最近7天，用于：
  - 主界面的"每周训练目标"显示
  - 周统计分析
- **超过7天的数据**：自动清除，节省存储空间

## 积分计算逻辑

积分现在**只计算今天的运动数据**：
- 基础积分：每10卡路里 = 1积分
- 里程碑奖励：完成20%、40%、60%、80%、100%目标
- 超额完成奖励：超过100%每1%额外2积分（上限150%）
- 多样性奖励：完成3种或以上不同运动，每种8积分
- 下限保护：至少完成20%才有积分

## 测试场景

### 场景1：正常使用（同一天）
1. 用户在运动界面添加运动记录
2. 主界面立即显示今天的卡路里消耗
3. 积分实时更新

### 场景2：跨天更新
1. 用户昨天完成了一些运动（如：消耗300卡路里，50积分）
2. 今天打开应用
3. **预期结果**：
   - 运动界面显示空白（今天没有运动）
   - 主界面今天的卡路里显示为0
   - 积分重置为0
   - 周统计仍然显示昨天的完成状态

### 场景3：周统计
1. 用户在过去7天内有运动记录
2. 主界面的"每周训练目标"正确显示最近7天的完成情况
3. 超过7天的数据不再显示

## 注意事项

1. **首次使用**：如果 `lastActiveDate` 为空（首次安装），不会清除数据
2. **时区**：使用系统默认时区和日历
3. **数据持久化**：所有更改自动保存到 SharedPreferences
4. **性能**：日期检查仅在界面加载时执行一次，不影响性能

## 技术细节

- 日期格式：`SimpleDateFormat("yyyyMMdd", Locale.getDefault())`
- 数据存储：SharedPreferences
- 状态管理：StateFlow (Kotlin Flow)
- UI更新：LaunchedEffect (Jetpack Compose)

